{"inputs":"!FCPREFIX!package main\n\nimport (\n\t\"bytes\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"io\"\n\t\"net/http\"\n\t\"os\"\n\t\"strings\"\n\n\t\"github.com/gin-gonic/gin\"\n)\n\nconst (\n\tcompletionURL = \"https://fc.fittenlab.cn/codeapi/completion/generate_one_stage/\"\n)\n\nfunc handleAll(c *gin.Context) {\n\tcontent, err := io.ReadAll(c.Request.Body)\n\tif err != nil {\n\t\tfmt.Println(err)\n\t\treturn\n\t}\n\n\treqStr := string(content)\n\tbody := bytes.NewBuffer(content)\n\tif strings.Contains(reqStr, DefaultConf.Cursor) {\n\t\thandleCompletions(c, body)\n\t} else {\n\t\thandleChat(c, body)\n\t}\n}\n\nfunc handleCompletions(c *gin.Context, body *bytes.Buffer) {\n\treq := \u0026LspAIReq{}\n\terr := json.NewDecoder(body).Decode(req)\n\tif err != nil {\n\t\treturn\n\t}\n\n\tif len(req.Messages) \u003c 2 {\n\t\treturn\n\t}\n\n\tvar msg string\n\tcursor := DefaultConf.GetCursor()\n\tif cursor == \"\" {\n\t\tfmt.Println(\"no cursor specified!\")\n\t\tos.Exit(1)\n\t}\n\n\tfor _, m := range req.Messages {\n\t\tif m.Role == RoleUser {\n\t\t\tif strings.Contains(m.Content, cursor) {\n\t\t\t\tmsg = m.Content\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tif msg == \"\" {\n\t\treturn\n\t}\n\tresult := strings.SplitN(msg, cursor, 2)\n\tprefix := strings.TrimSpace(result[0])\n\tsuffix := result[1]\n\n\tprompt := fmt.Sprintf(FCodeCompletionPrompt, prefix, suffix)\n\tpayload := map[string]any{\n\t\t\"inputs\": prompt,\n\t}\n\n\tpayloadJSON, _ := json.Marshal(payload)\n\tp := \"/Users/moqsien/projects/go/src/fcode/payload.json\"\n\tos.WriteFile(p, payloadJSON, os.ModePerm)\n\n\turl := fmt.Sprintf(\"%s/%s?ide=%s\u0026v=%s\", completionURL, DefaultKey.APIKey, IdeName, PluginVersion)\n\tresp, err := http.Post(url, \"application/json\", bytes.NewReader(payloadJSON))\n\tif err != nil {\n\t\tfmt.Println(err)\n\t\treturn\n\t}\n\n\tr := \u0026CompletionResponse{}\n\terr = json.NewDecoder(resp.Body).Decode(r)\n\tif err != nil {\n\t\tfmt.Println(err)\n\t\treturn\n\t}\n\n\tfmt.!FCSUFFIX!\n\tcomp := strings.ReplaceAll(r.GeneratedText, \"\u003c.endoftext.\u003e\", \"\")\n\tcomp = strings.ReplaceAll(comp, `\u003c|endoftext|\u003e`, \"\")\n\n\tlspAIResp := \u0026Response{\n\t\t[]Choice{\n\t\t\t{\n\t\t\t\tFinishReason: \"stop\",\n\t\t\t\tMessage: Message{\n\t\t\t\t\tContent: comp,\n\t\t\t\t\tRole:    RoleAssistant,\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\n\tc.JSON(http.StatusOK, lspAIResp)\n\n}\n!FCMIDDLE!"}